<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="Cache-Control" content="no-store" />
  <meta http-equiv="Pragma" content="no-cache" />
  <title>Avatar Customizer - Dressify AI</title>
  <script type="module" src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.esm.js"></script>
  <script nomodule src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.js"></script>
  <link rel="stylesheet" href="css/indexstyle.css">
  <style>
    /* =========================================
       GLOBAL & RESET
       ========================================= */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: #f4f6f8;
      color: #333;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 40px 20px;
    }

    /* =========================================
       DASHBOARD GRID (The 2x2 Layout)
       ========================================= */
    .dashboard-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 30px;
      align-items: stretch;
    }

    /* Mobile Responsive */
    @media (max-width: 950px) {
      .dashboard-grid {
        grid-template-columns: 1fr;
      }
    }

    /* =========================================
       CARDS & CONTAINERS
       ========================================= */
    .card {
      background: #ffffff;
      border-radius: 20px;
      padding: 30px;
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.04);
      display: flex;
      flex-direction: column;
      border: 1px solid #eaeef2;
      height: 100%;
    }

    .card h2 {
      color: #1a1a1a;
      margin-bottom: 25px;
      display: flex;
      align-items: center;
      gap: 12px;
      font-size: 1.3rem;
      font-weight: 800;
      border-bottom: 2px solid #f4f6f8;
      padding-bottom: 15px;
    }

    .card h2 ion-icon {
      color: #B76E79;
      font-size: 1.6rem;
    }

    /* =========================================
       AVATAR PREVIEW CANVAS (PERFECT FIT MATH)
       ========================================= */
    .title-accent {
      text-align: center;
      font-size: 1.4rem;
      font-weight: 800;
      color: #1a1a1a;
      margin-bottom: 20px;
    }

    .avatar-stack {
      position: relative;
      width: 100%;
      max-width: 260px;
      height: 400px; 
      margin: 0 auto 25px auto;
      background: radial-gradient(circle at 50% 30%, #ffffff 0%, #e2e8f0 100%);
      border-radius: 20px;
      overflow: hidden;
      display: flex;
      flex-direction: column;
      border: 1px solid #cbd5e1;
      box-shadow: inset 0 4px 15px rgba(0,0,0,0.05);
    }

    /* Head Zone - Height increased to ensure neck is fully visible */
    .head-crop-zone {
      width: 100%;
      height: 155px; 
      overflow: hidden;
      position: relative;
      z-index: 40;
    }

    /* Bitmoji Face */
    .bitmoji-face {
      position: absolute;
      top: 15px;
      left: 50%;
      width: 145px; 
      height: auto; 
      object-fit: contain;
      transform-origin: top center;
      transform: translateX(-50%) scale(1.30); 
    }

    /* Clothing Zone - Pulled up to cover the neck */
    .clothes-zone {
      flex: 1;
      width: 100%;
      position: relative;
      margin-top: -24px; 
      z-index: 20;
    }

    .clothing-layer {
      position: absolute;
      left: 50%;
      transform: translateX(-50%);
      object-fit: contain;
      pointer-events: none;
      /* Default shadow, augmented by JS dynamically */
      filter: drop-shadow(0 4px 8px rgba(0,0,0,0.15));
    }

    /* Mannequin Dummy Body */
    .dummy-body-ref {
      top: 5px;
      width: 95px; 
      z-index: 5; 
      opacity: 0.4; 
      filter: none !important;
    }

    /* 1. Shirt covers torso and overlaps pants */
    .shirt-ref {
      top: -2px;
      width: 155px; 
      z-index: 30; 
    }

    /* 2. Pants tuck under the shirt */
    .pants-ref {
      top: 110px; 
      width: 115px; 
      z-index: 20; 
    }

    /* 3. Shoes - CORRECTLY MIRRORED AND FLAT ON THE GROUND */
    .shoes-ref {
      top: 215px; /* Safely anchored so legs do not hang in the air */
      width: 105px; 
      z-index: 10;
      display: flex;
      justify-content: space-between; 
      align-items: flex-end;
    }

    .shoe-left, .shoe-right {
      width: 45%;
      height: auto;
      object-fit: contain;
    }

    /* ONLY flip the left shoe horizontally! Right shoe stays normal. No more upside down! */
    .shoe-left {
      transform: scaleX(-1); 
    }

    .shoe-right {
      transform: scaleX(1);
    }

    /* =========================================
       INPUTS, FORMS, & BUTTONS
       ========================================= */
    .avatar-actions {
      display: flex;
      flex-direction: column;
      gap: 15px;
      width: 100%;
      max-width: 260px;
      margin: 0 auto;
    }

    .custom-input,
    .avatar-name-field {
      width: 100%;
      padding: 14px 18px;
      border: 2px solid #eaeaea;
      border-radius: 10px;
      font-size: 0.95rem;
      font-weight: 600;
      color: #1a1a1a;
      background: #fdfdfd;
      transition: all 0.3s ease;
      outline: none;
    }

    .custom-input:focus,
    .avatar-name-field:focus {
      border-color: #B76E79;
      background: #fff;
      box-shadow: 0 0 0 4px rgba(183, 110, 121, 0.1);
    }

    .action-buttons {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }

    /* Premium Modern Buttons */
    .btn-snap-styled {
      padding: 14px 10px;
      border-radius: 10px;
      font-weight: 700;
      font-size: 0.9rem;
      cursor: pointer;
      border: none;
      background: #FFFC00;
      color: #111;
      transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      box-shadow: 0 4px 10px rgba(255, 252, 0, 0.3);
    }

    .btn-snap-styled:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 15px rgba(255, 252, 0, 0.4);
    }
    
    .btn-snap-styled:active {
      transform: translateY(1px);
      box-shadow: 0 2px 5px rgba(255, 252, 0, 0.2);
    }

    .black-btn {
      background: #1a1a1a;
      color: #fff;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.15);
    }

    .black-btn:hover {
      background: #000;
      box-shadow: 0 6px 15px rgba(0, 0, 0, 0.25);
    }

    .btn-primary {
      background: linear-gradient(135deg, #B76E79 0%, #CD7F32 100%);
      color: white;
      width: 100%;
      padding: 15px;
      border: none;
      border-radius: 12px;
      font-weight: 800;
      font-size: 1rem;
      cursor: pointer;
      transition: all 0.3s;
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(183, 110, 121, 0.3);
    }

    /* =========================================
       BITMOJI CLOSET & WARDROBE
       ========================================= */
    .wardrobe-header {
      display: flex;
      flex-direction: column;
      gap: 15px;
    }

    .category-tabs {
      display: flex;
      background: #f0f2f5;
      padding: 6px;
      border-radius: 12px;
      margin-bottom: 15px;
    }

    .tab-item {
      flex: 1;
      border: none;
      background: transparent;
      padding: 10px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 700;
      font-size: 0.9rem;
      color: #7f8c8d;
      transition: all 0.2s ease;
    }

    .tab-item.active {
      background: white;
      color: #1a1a1a;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.08);
    }

    .snap-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(90px, 1fr));
      gap: 15px;
      max-height: 400px;
      overflow-y: auto;
      padding: 5px 10px 10px 5px;
    }

    .snap-grid::-webkit-scrollbar {
      width: 6px;
    }

    .snap-grid::-webkit-scrollbar-thumb {
      background: #dcdde1;
      border-radius: 10px;
    }

    .wardrobe-item {
      aspect-ratio: 1/1;
      background: #f8f9fa;
      border-radius: 16px;
      padding: 15px;
      border: 2px solid transparent;
      cursor: pointer;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .wardrobe-item img {
      width: 85%;
      height: 85%;
      object-fit: contain;
      transition: transform 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    }

    .wardrobe-item:hover {
      background: #f1f2f6;
      border-color: #e1e4e8;
    }

    .wardrobe-item:hover img {
      transform: scale(1.15);
    }

    .wardrobe-item.selected {
      border-color: #FFFC00;
      background: #fffdf0;
      box-shadow: 0 4px 12px rgba(255, 252, 0, 0.15);
    }

    /* =========================================
       CUSTOMIZATION & UPLOAD SECTION
       ========================================= */
    .form-grid {
      display: flex;
      flex-direction: column;
      gap: 15px;
      margin-bottom: 20px;
    }

    .form-group label {
      display: block;
      margin-bottom: 8px;
      color: #1a1a1a;
      font-weight: 700;
      font-size: 0.9rem;
    }

    .upload-area {
      border: 2px dashed #B76E79;
      border-radius: 12px;
      padding: 30px 20px;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s ease;
      background: #fffbfa;
    }

    .upload-area:hover {
      background: #fff5f5;
      border-color: #CD7F32;
    }

    .upload-area ion-icon {
      font-size: 2.5rem;
      color: #B76E79;
      margin-bottom: 10px;
    }

    .upload-area p {
      color: #7f8c8d;
      font-weight: 600;
      font-size: 0.95rem;
    }

    /* =========================================
       LOOKBOOK & MESSAGES
       ========================================= */
    .empty-msg {
      color: #95a5a6;
      text-align: center;
      padding: 40px 20px;
      font-style: italic;
      background: #f8f9fa;
      border-radius: 12px;
      border: 1px dashed #dcdde1;
    }

    .lookbook-display {
      flex: 1;
      display: flex;
      flex-direction: column;
      justify-content: center;
    }

    .message {
      padding: 15px;
      border-radius: 10px;
      margin-bottom: 15px;
      font-weight: 600;
      font-size: 0.9rem;
      display: none;
    }

    .message.success {
      background: #e8f8f5;
      color: #27ae60;
      border: 1px solid #c8e6c9;
      display: block;
    }

    .message.error {
      background: #fdfeff;
      color: #e74c3c;
      border: 1px solid #fadbd8;
      display: block;
    }

    /* Animation - Preserves scale during pop-in */
    .reflect-anim {
      animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    }

    @keyframes popIn {
      0% { transform: translateX(-50%) scale(1.1); opacity: 0.5; }
      100% { transform: translateX(-50%) scale(1); opacity: 1; }
    }
  </style>
</head>

<body>
  <!-- Navigation -->
  <nav class="navbar">
    <div class="nav-container">
      <div class="nav-brand">
        <a href="index.html">
          <ion-icon name="bag-handle-outline"></ion-icon>
          <span>Dressify AI</span>
        </a>
      </div>

      <button class="nav-toggle" onclick="toggleNavMenu()">
        <ion-icon name="menu-outline"></ion-icon>
      </button>

      <ul class="nav-menu" id="navMenu">
        <li><a href="index.html" class="nav-link"><ion-icon name="home-outline"></ion-icon> Home</a></li>
        <li><a href="ai-hub.html" class="nav-link"><ion-icon name="sparkles-outline"></ion-icon> AI Hub</a></li>
        <li><a href="avatar-customizer.html" class="nav-link"><ion-icon name="person-outline"></ion-icon> Avatar</a>
        </li>
        <li><a href="gemini_chatbot.html" class="nav-link"><ion-icon name="chatbubbles-outline"></ion-icon> Chat</a>
        </li>
        <li><a href="bodyshape.html" class="nav-link"><ion-icon name="body-outline"></ion-icon> Body Shape</a></li>
        <li class="nav-divider"></li>
        <li><a href="login.html" class="nav-link auth-btn"><ion-icon name="log-in-outline"></ion-icon> Login</a></li>
        <li><a href="signup.html" class="nav-link auth-btn primary"><ion-icon name="person-add-outline"></ion-icon> Sign
            Up</a></li>
      </ul>
    </div>
  </nav>

  <section class="hero" style="text-align: center; padding: 40px 20px; background: #fff; margin-bottom: 20px; border-bottom: 1px solid #eee;">
    <div class="hero-container">
      <h1 style="font-size: 2.5rem; color: #1a1a1a; font-weight: 800; margin-bottom: 10px;">ðŸ‘¤ Dressify AI Avatar Creator</h1>
      <p style="color: #7f8c8d; font-size: 1.1rem; font-weight: 500;">Customize your 3D avatar and try on different outfits</p>
    </div>
  </section>

  <!-- PROFESSIONAL DASHBOARD LAYOUT -->
  <div class="container">
    <div class="dashboard-grid">
      
      <!-- 1. TOP LEFT: Avatar Card -->
      <div class="card editor-card avatar-card">
        <h2 id="displayNameArea" class="title-accent">Guest User</h2>
        <div class="avatar-stack" id="avatarPreviewBox">
          <div class="head-crop-zone">
            <!-- Default placeholder will be updated by JS if logged in -->
            <img id="userBitmoji" src="https://api.dicebear.com/7.x/avataaars/svg?seed=Guest&backgroundColor=b6e3f4" class="bitmoji-face">
          </div>
          <div class="clothes-zone">
            <!-- SLEEK MANNEQUIN BODY - Legs shortened so they don't poke past the raised shoes -->
            <img id="dummyBody" src="data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 120 350'><rect x='45' y='0' width='30' height='40' rx='10' fill='%23cbd5e1'/><path d='M30 30 Q60 15 90 30 L80 180 L40 180 Z' fill='%2394a3b8'/><rect x='40' y='170' width='16' height='110' rx='8' fill='%23cbd5e1'/><rect x='64' y='170' width='16' height='110' rx='8' fill='%23cbd5e1'/></svg>" class="clothing-layer dummy-body-ref">
            
            <img id="reflectTop" src="" class="clothing-layer shirt-ref" style="display:none;">
            <img id="reflectBottom" src="" class="clothing-layer pants-ref" style="display:none;">
            
            <!-- MIRRORED SHOE CONTAINER -->
            <div id="reflectShoes" class="clothing-layer shoes-ref" style="display:none;">
                <img class="shoe-left" src="">
                <img class="shoe-right" src="">
            </div>
          </div>
        </div>

        <div class="avatar-actions">
          <input type="text" id="avatarNameInput" class="avatar-name-field" placeholder="Enter Avatar Name...">
          
          <div class="action-buttons">
            <button class="btn-snap-styled black-btn" onclick="createAvatar()">Save Name</button>
            <button class="btn-snap-styled" onclick="saveCurrentOutfit()">
              <ion-icon name="save-outline" style="font-size: 1.1rem;"></ion-icon> Save Outfit
            </button>
            
            <!-- Dynamic Login/Logout Buttons -->
            <button class="btn-snap-styled" id="loginBtn" onclick="startSnapLogin()">
              <ion-icon name="logo-snapchat"></ion-icon> Connect Snapchat
            </button>
            <button class="btn btn-secondary" id="logoutBtn" onclick="logoutAndSwitch()" style="display:none; padding: 8px 15px; border-radius: 8px; border: none; background: #eee; cursor:pointer;">
              <ion-icon name="log-out-outline"></ion-icon> Switch User / Logout
            </button>
          </div>

        </div>
      </div>

      <!-- 2. TOP RIGHT: Bitmoji Closet -->
      <div class="card editor-card wardrobe-container">
        <div class="wardrobe-header">
          <h2><ion-icon name="shirt-outline"></ion-icon> Bitmoji Closet</h2>
          <div class="category-tabs">
            <button class="tab-item active" onclick="changeCategory('tops', this)">Tops</button>
            <button class="tab-item" onclick="changeCategory('bottoms', this)">Bottoms</button>
            <button class="tab-item" onclick="changeCategory('shoes', this)">Shoes</button>
          </div>
        </div>
        <div id="wardrobeGrid" class="snap-grid">
          <!-- Items populated by JS -->
        </div>
      </div>

      <!-- 3. BOTTOM LEFT: Customization Card -->
      <div class="card settings-card customization-card">
        <h2><ion-icon name="color-palette-outline"></ion-icon> Customization</h2>
        <div id="messageBox"></div>
        <div class="form-grid">
          <div class="form-group">
            <label>Skin Tone</label>
            <select id="skinTone" class="custom-input">
              <option value="light">Light</option>
              <option value="medium" selected>Medium</option>
              <option value="dark">Dark</option>
            </select>
          </div>
          <div class="form-group">
            <label>Reference Image</label>
            <div class="upload-area" id="uploadArea" onclick="document.getElementById('avatarImage').click()">
              <ion-icon name="cloud-upload-outline"></ion-icon>
              <p>Click to upload reference</p>
            </div>
            <input type="file" id="avatarImage" accept="image/*" style="display:none;">
          </div>
        </div>
        <button class="btn btn-primary" onclick="createAvatar()">
          Update Profile
        </button>
      </div>

      <!-- 4. BOTTOM RIGHT: Saved Lookbook -->
      <div class="card settings-card saved-outfits">
        <h2><ion-icon name="bookmark-outline"></ion-icon> Saved Lookbook</h2>
        <div id="savedOutfitsContainer" class="lookbook-display">
          <p class="empty-msg">Your saved styles will appear here.</p>
        </div>
      </div>

    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  <script>
    const API_URL = "http://127.0.0.1:8000/api";
    axios.defaults.withCredentials = true;
    const userId = 'user_' + Date.now();
    let currentAvatar = null;
    let currentTab = 'tops';

    let currentOutfit = {
      tops: null,
      bottoms: null,
      shoes: null
    };

    // =========================================================================
    // 100% BULLETPROOF DATABASE 
    // We only request the 10 absolute base images we KNOW work on the server.
    // Then, we use CSS Filters to instantly dye them into 30 unique designer items!
    // =========================================================================
    const baseIcons = {
        tee: 'https://img.icons8.com/color/96/t-shirt.png',
        hoodie: 'https://img.icons8.com/color/96/hoodie.png',
        jacket: 'https://img.icons8.com/color/96/jacket.png',
        sweater: 'https://img.icons8.com/color/96/sweater.png',
        jeans: 'https://img.icons8.com/color/96/jeans.png',
        trousers: 'https://img.icons8.com/color/96/trousers.png',
        shorts: 'https://img.icons8.com/color/96/shorts.png',
        sweatpants: 'https://img.icons8.com/color/96/sweatpants.png',
        sneaker: 'https://img.icons8.com/color/96/sneakers.png',
        shoe: 'https://img.icons8.com/color/96/mens-shoe.png'
    };

    const clothingDatabase = {
      tops: [
        { id: 't1', name: 'Classic Green Tee', image: baseIcons.tee, filter: 'none' },
        { id: 't2', name: 'Midnight Black Tee', image: baseIcons.tee, filter: 'grayscale(100%) brightness(30%)' },
        { id: 't3', name: 'Grey Urban Hoodie', image: baseIcons.hoodie, filter: 'grayscale(100%) brightness(130%)' },
        { id: 't4', name: 'Crimson Red Hoodie', image: baseIcons.hoodie, filter: 'hue-rotate(150deg) saturate(150%)' },
        { id: 't5', name: 'Blue Denim Jacket', image: baseIcons.jacket, filter: 'none' },
        { id: 't6', name: 'Dark Leather Jacket', image: baseIcons.jacket, filter: 'grayscale(100%) brightness(40%)' },
        { id: 't7', name: 'Mustard Knit Sweater', image: baseIcons.sweater, filter: 'hue-rotate(320deg) saturate(150%) brightness(110%)' },
        { id: 't8', name: 'Plum Violet Sweater', image: baseIcons.sweater, filter: 'hue-rotate(200deg) saturate(120%)' },
        { id: 't9', name: 'White Graphic Tee', image: baseIcons.tee, filter: 'grayscale(100%) brightness(250%)' },
        { id: 't10', name: 'Neon Pink Hoodie', image: baseIcons.hoodie, filter: 'hue-rotate(280deg) saturate(200%) brightness(120%)' }
      ],
      bottoms: [
        { id: 'b1', name: 'Classic Blue Jeans', image: baseIcons.jeans, filter: 'none' },
        { id: 'b2', name: 'Faded Grey Jeans', image: baseIcons.jeans, filter: 'grayscale(100%) brightness(120%)' },
        { id: 'b3', name: 'Black Tailored Trousers', image: baseIcons.trousers, filter: 'grayscale(100%) brightness(30%)' },
        { id: 'b4', name: 'Navy Dress Pants', image: baseIcons.trousers, filter: 'hue-rotate(200deg) saturate(80%) brightness(60%)' },
        { id: 'b5', name: 'Khaki Summer Shorts', image: baseIcons.shorts, filter: 'sepia(100%) hue-rotate(350deg) saturate(150%) brightness(90%)' },
        { id: 'b6', name: 'Coral Beach Shorts', image: baseIcons.shorts, filter: 'hue-rotate(120deg) saturate(150%) brightness(110%)' },
        { id: 'b7', name: 'Heather Grey Sweats', image: baseIcons.sweatpants, filter: 'none' },
        { id: 'b8', name: 'Maroon Track Pants', image: baseIcons.sweatpants, filter: 'hue-rotate(140deg) saturate(120%) brightness(80%)' },
        { id: 'b9', name: 'Dark Wash Denim', image: baseIcons.jeans, filter: 'brightness(60%) saturate(120%)' },
        { id: 'b10', name: 'Olive Tech Cargos', image: baseIcons.trousers, filter: 'sepia(100%) hue-rotate(50deg) saturate(120%) brightness(70%)' }
      ],
      shoes: [
        { id: 's1', name: 'White High-Tops', image: baseIcons.sneaker, filter: 'grayscale(100%) brightness(200%)' },
        { id: 's2', name: 'Black Skater Shoes', image: baseIcons.sneaker, filter: 'grayscale(100%) brightness(30%)' },
        { id: 's3', name: 'Hype Red Kicks', image: baseIcons.sneaker, filter: 'hue-rotate(140deg) saturate(150%)' },
        { id: 's4', name: 'Brown Oxfords', image: baseIcons.shoe, filter: 'sepia(80%) hue-rotate(340deg) brightness(80%)' },
        { id: 's5', name: 'Black Dress Shoes', image: baseIcons.shoe, filter: 'grayscale(100%) brightness(30%)' },
        { id: 's6', name: 'Neon Green Runners', image: baseIcons.sneaker, filter: 'hue-rotate(260deg) saturate(200%)' },
        { id: 's7', name: 'Navy Slip-ons', image: baseIcons.shoe, filter: 'hue-rotate(200deg) saturate(120%) brightness(70%)' },
        { id: 's8', name: 'Vintage Yellow Kicks', image: baseIcons.sneaker, filter: 'hue-rotate(320deg) saturate(150%) brightness(110%)' },
        { id: 's9', name: 'Cherry Loafers', image: baseIcons.shoe, filter: 'hue-rotate(140deg) saturate(120%) brightness(60%)' },
        { id: 's10', name: 'Violet Trainers', image: baseIcons.sneaker, filter: 'hue-rotate(200deg) saturate(150%)' }
      ]
    };

    const uploadArea = document.getElementById('uploadArea');
    const avatarImageInput = document.getElementById('avatarImage');

    if (uploadArea) {
      uploadArea.addEventListener('dragover', (e) => {
        e.preventDefault();
        uploadArea.classList.add('active');
      });

      uploadArea.addEventListener('dragleave', () => {
        uploadArea.classList.remove('active');
      });

      uploadArea.addEventListener('drop', (e) => {
        e.preventDefault();
        uploadArea.classList.remove('active');
        if (avatarImageInput) {
          avatarImageInput.files = e.dataTransfer.files;
          previewImage();
        }
      });
    }

    if (avatarImageInput) {
      avatarImageInput.addEventListener('change', previewImage);
    }

    function previewImage() {
      const file = avatarImageInput.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = (e) => {
          // Future avatar preview logic
        };
        reader.readAsDataURL(file);
      }
    }

    function showMessage(msg, type) {
      const box = document.getElementById('messageBox');
      box.textContent = msg;
      box.className = `message ${type}`;
      setTimeout(() => {
        box.className = 'message';
      }, 3000);
    }

    const startSnapLogin = () => {
      // Directs to Flask OAuth Route
      window.location.href = "http://127.0.0.1:8000/api/avatar/snap/login";
    };

    async function loadSnapProfile() {
      try {
        const response = await fetch('http://127.0.0.1:8000/api/avatar/session', {
          credentials: 'include'
        });
        const data = await response.json();

        const baseImg = document.getElementById('userBitmoji');
        const displayNameArea = document.getElementById('displayNameArea');
        const avatarNameInput = document.getElementById('avatarNameInput');
        const loginBtn = document.getElementById('loginBtn');
        const logoutBtn = document.getElementById('logoutBtn');

        if (data.user) {
          // Logged In State
          if (baseImg && data.user.bitmoji && data.user.bitmoji.avatar) {
            baseImg.src = data.user.bitmoji.avatar;
            baseImg.style.display = 'block';
          }
          
          displayNameArea.textContent = data.user.displayName || "Snapchat User";
          avatarNameInput.value = data.user.displayName || "";
          
          loginBtn.style.display = 'none';
          logoutBtn.style.display = 'flex'; 
        } else {
          // Guest State
          displayNameArea.textContent = "Guest User";
          if (baseImg) {
            baseImg.src = "https://api.dicebear.com/7.x/avataaars/svg?seed=Guest&backgroundColor=b6e3f4";
          }
          loginBtn.style.display = 'flex';
          logoutBtn.style.display = 'none';
        }
      } catch (err) {
        console.error("Session failed:", err);
        // Fallback to Guest State on error
        document.getElementById('displayNameArea').textContent = "Guest User";
        document.getElementById('loginBtn').style.display = 'flex';
        document.getElementById('logoutBtn').style.display = 'none';
      }
    }

    window.addEventListener('DOMContentLoaded', loadSnapProfile);

    function changeCategory(category, element) {
      document.querySelectorAll('.tab-item').forEach(btn => btn.classList.remove('active'));
      element.classList.add('active');
      renderClothingItems(category);
    }

    const baseDropShadow = 'drop-shadow(0 4px 8px rgba(0,0,0,0.15))';

    function renderClothingItems(category) {
      const container = document.getElementById('wardrobeGrid');
      const items = clothingDatabase[category] || [];

      if (items.length === 0) {
        container.innerHTML = `<div class="empty-msg" style="grid-column: 1/-1;">Coming soon to ${category}!</div>`;
        return;
      }

      container.innerHTML = items.map(item => {
        // Apply the CSS filter directly in the grid so users can see the color changes!
        const appliedFilter = item.filter !== 'none' ? `${item.filter} ${baseDropShadow}` : baseDropShadow;
        return `
        <div class="wardrobe-item ${currentOutfit[category] === item.id ? 'selected' : ''}" 
             onclick="selectItem('${category}', '${item.id}', this)">
            <img src="${item.image}" alt="${item.name}" title="${item.name}" style="filter: ${appliedFilter};">
        </div>
        `;
      }).join('');
    }

    function selectItem(category, itemId, element) {
      const itemData = clothingDatabase[category].find(i => i.id === itemId);
      if (!itemData) return;

      const layerMap = {
        'tops': 'reflectTop',
        'bottoms': 'reflectBottom',
        'shoes': 'reflectShoes'
      };

      const targetImg = document.getElementById(layerMap[category]);

      if (targetImg) {
        // Construct the final filter string
        const appliedFilter = itemData.filter !== 'none' ? `${itemData.filter} ${baseDropShadow}` : baseDropShadow;

        if (category === 'shoes') {
            targetImg.querySelector('.shoe-left').src = itemData.image;
            targetImg.querySelector('.shoe-right').src = itemData.image;
            
            // Apply the color filter to both left and right shoes!
            targetImg.querySelector('.shoe-left').style.filter = appliedFilter;
            targetImg.querySelector('.shoe-right').style.filter = appliedFilter;
            targetImg.style.display = 'flex';
        } else {
            targetImg.src = itemData.image;
            targetImg.style.filter = appliedFilter;
            targetImg.style.display = 'block';
        }
        
        targetImg.classList.remove('reflect-anim');
        void targetImg.offsetWidth; // Trigger reflow
        targetImg.classList.add('reflect-anim');
        
        currentOutfit[category] = itemId;
      }
      
      const allItems = element.parentElement.querySelectorAll('.wardrobe-item');
      allItems.forEach(el => el.classList.remove('selected'));
      element.classList.add('selected');
    }

    async function createAvatar() {
      const nameField = document.getElementById("avatarNameInput");
      const nameValue = nameField ? nameField.value.trim() : "";

      if (!nameValue) {
        alert("Please enter a name for your avatar first!");
        return;
      }

      try {
        const response = await fetch("http://127.0.0.1:8000/api/avatar/create", {
          method: "POST",
          headers: {
            "Content-Type": "application/json"
          },
          credentials: "include",
          body: JSON.stringify({ "name": nameValue })
        });

        const data = await response.json();

        if (response.ok) {
          alert("Avatar Profile Saved!");
        } else {
          console.error("Server Error:", data);
        }
      } catch (err) {
        console.error("Network Error:", err);
      }
    }

    async function saveCurrentOutfit() {
      try {
        const response = await fetch(`${API_URL}/avatar/${userId}/save-outfit`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            outfitName: 'Outfit ' + new Date().toLocaleDateString(),
            outfit: currentOutfit
          })
        });

        if (response.ok) {
          showMessage('Outfit saved successfully!', 'success');
          loadSavedOutfits();
        }
      } catch (error) {
        showMessage('Error saving outfit', 'error');
      }
    }

    async function loadSavedOutfits() {
      try {
        const response = await fetch(`${API_URL}/avatar/${userId}/outfits`);
        const data = await response.json();

        const container = document.getElementById('savedOutfitsContainer');
        if (data.outfits && data.outfits.length > 0) {
          container.innerHTML = data.outfits.map(outfit => `
            <div style="background: #f4f6f8; border-left: 4px solid #B76E79; padding: 15px; margin-bottom: 10px; border-radius: 8px;">
              <h4 style="color:#B76E79; margin-bottom:5px;">${outfit.name}</h4>
              <button class="btn-snap-styled black-btn" style="padding: 8px 12px; font-size: 0.8rem;" onclick="loadOutfit(${outfit.id})">Load</button>
            </div>
          `).join('');
        }
      } catch (error) {
        console.error('Error loading outfits:', error);
      }
    }

    function loadOutfit(outfitId) {
      showMessage('Outfit loaded!', 'success');
    }

    // Initialize UI
    renderClothingItems('tops');

    window.addEventListener('DOMContentLoaded', () => {
      // Check query params specifically if passing manual mock data (optional fallback)
      const params = new URLSearchParams(window.location.search);
      const snapName = params.get('name');
      const snapBitmoji = params.get('bitmoji');

      if (snapBitmoji) {
        const img = document.getElementById('userBitmoji');
        img.src = snapBitmoji;
        img.style.display = 'block';
        document.getElementById('displayNameArea').textContent = snapName;
        document.getElementById('avatarNameInput').value = snapName;
      }
    });

    function logoutAndSwitch() {
      // Directs to Flask Logout Route
      window.location.href = "http://127.0.0.1:8000/api/avatar/logout";
    }
  </script>
  <script src="js/navbar-init.js"></script>

  <footer class="footer">
    <div class="footer__container section__container">
      <div class="footer__col">
        <div class="footer__logo">
          <a href="index.html">Dressify AI</a>
        </div>
        <p>
          Elevating fashion through artificial intelligence. Your personal stylist in your pocket, powered by cutting-edge AI.
        </p>
        <ul class="footer__socials">
          <li><a href="#"><ion-icon name="logo-facebook"></ion-icon></a></li>
          <li><a href="#"><ion-icon name="logo-instagram"></ion-icon></a></li>
          <li><a href="#"><ion-icon name="logo-twitter"></ion-icon></a></li>
        </ul>
      </div>
      <div class="footer__col">
        <h4>Navigation</h4>
        <ul class="footer__links">
          <li><a href="index.html">Home</a></li>
          <li><a href="ai-hub.html">AI Hub</a></li>
          <li><a href="avatar-customizer.html">Avatar</a></li>
          <li><a href="gemini_chatbot.html">Chat</a></li>
          <li><a href="bodyshape.html">Body Shape</a></li>
        </ul>
      </div>
      <div class="footer__col">
        <h4>Support</h4>
        <ul class="footer__links">
          <li><a href="contact.html">Contact Us</a></li>
          <li><a href="faq.html">FAQ</a></li>
          <li><a href="privacy.html">Privacy Policy</a></li>
          <li><a href="terms.html">Terms of Service</a></li>
        </ul>
      </div>
      <div class="footer__col">
        <h4>Join Us</h4>
        <p>Subscribe to get the latest fashion trends and AI style tips delivered to your inbox.</p>
        <form style="display: flex; gap: 10px; margin-top: 10px;">
          <input type="email" placeholder="Your email" style="padding: 10px 15px; border-radius: 20px; border: 1px solid rgba(255,255,255,0.1); background: rgba(255,255,255,0.05); color: white; flex: 1;">
          <button type="submit" class="btn" style="padding: 10px 20px; border-radius: 20px; background: var(--primary); color: white; border: none; cursor: pointer; font-size: 0.9rem;">Join</button>
        </form>
      </div>
    </div>
    <div class="footer__bar">
      &copy; 2026 Dressify AI. All rights reserved. Precision in Every Pixel.
    </div>
  </footer>
</body>

</html>