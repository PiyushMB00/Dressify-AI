<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="Cache-Control" content="no-store" />
  <meta http-equiv="Pragma" content="no-cache" />
  <title>Avatar Customizer - Dressify AI</title>
  <script type="module" src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.esm.js"></script>
  <script nomodule src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.js"></script>
  <link rel="stylesheet" href="css/indexstyle.css">
  <style>
    /* =========================================
       THEME OVERRIDE - Match main site theme
       ========================================= */
    body {
      font-family: 'Poppins', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: var(--light, #FDF5F6);
      color: var(--dark, #1F0A0A);
    }

    /* Page Hero */
    .avatar-hero {
      background: linear-gradient(135deg, #FADADD 0%, #FDF5F6 60%, #fef3f5 100%);
      padding: 50px 20px 35px;
      text-align: center;
      border-bottom: 1px solid rgba(183, 110, 121, 0.15);
      position: relative;
      overflow: hidden;
    }

    .avatar-hero::before {
      content: '';
      position: absolute;
      top: -60px;
      right: -60px;
      width: 220px;
      height: 220px;
      background: radial-gradient(circle, rgba(183, 110, 121, 0.12) 0%, transparent 70%);
      border-radius: 50%;
    }

    .avatar-hero h1 {
      font-size: 2.6rem;
      font-weight: 800;
      color: var(--mahogany, #4D0F0F);
      margin-bottom: 10px;
    }

    .avatar-hero p {
      color: var(--gray, #6C757D);
      font-size: 1.05rem;
      font-weight: 500;
    }

    /* =========================================
       DASHBOARD GRID
       ========================================= */
    .avatar-page-container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 40px 20px 60px;
    }

    .dashboard-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 28px;
      align-items: stretch;
    }

    @media (max-width: 950px) {
      .dashboard-grid {
        grid-template-columns: 1fr;
      }

      .avatar-hero h1 {
        font-size: 2rem;
      }
    }

    /* =========================================
       CARDS
       ========================================= */
    .card {
      background: #ffffff;
      border-radius: 22px;
      padding: 28px;
      box-shadow: 0 8px 30px rgba(183, 110, 121, 0.08);
      border: 1px solid rgba(183, 110, 121, 0.12);
      display: flex;
      flex-direction: column;
      height: 100%;
    }

    .card h2 {
      color: var(--mahogany, #4D0F0F);
      margin-bottom: 22px;
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 1.25rem;
      font-weight: 800;
      border-bottom: 2px solid #FADADD;
      padding-bottom: 14px;
    }

    .card h2 ion-icon {
      color: var(--primary, #B76E79);
      font-size: 1.5rem;
    }

    /* =========================================
       AVATAR PREVIEW â€” THE MANNEQUIN
       ========================================= */
    .avatar-display-name {
      text-align: center;
      font-size: 1.3rem;
      font-weight: 800;
      color: var(--mahogany, #4D0F0F);
      margin-bottom: 18px;
    }

    /* Main mannequin container */
    .avatar-canvas {
      position: relative;
      width: 100%;
      max-width: 250px;
      height: 420px;
      margin: 0 auto 22px auto;
      border-radius: 20px;
      overflow: hidden;
      background: radial-gradient(circle at 50% 30%, #fff9fa 0%, #FADADD 100%);
      border: 1.5px solid rgba(183, 110, 121, 0.2);
      box-shadow: 0 8px 24px rgba(183, 110, 121, 0.1);
      display: flex;
      align-items: center;
      justify-content: center;
    }

    /* The full mannequin image â€” width-anchored so position is always predictable */
    .mannequin-img {
      position: absolute;
      bottom: 0;
      left: 0;
      width: 100%;
      /* always 250px wide */
      height: auto;
      /* auto height = 250px (1:1 ratio) â€” sits at bottom */
      object-fit: contain;
      z-index: 5;
    }

    /* Bitmoji head overlay â€” shown ONLY when logged in */
    .bitmoji-overlay {
      position: absolute;
      top: 10px;
      left: 50%;
      transform: translateX(-50%);
      width: 96px;
      height: 96px;
      border-radius: 50%;
      object-fit: cover;
      object-position: top center;
      z-index: 30;
      display: none;
      border: 3px solid white;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      background: #f0f0f0;
    }

    /* Clothing overlay layers â€” calibrated for 250Ã—250 mannequin  */
    /* sitting at bottom of 420px canvas = mannequin starts at y=170px */
    .clothes-zone {
      position: absolute;
      inset: 0;
      z-index: 15;
      pointer-events: none;
    }

    .clothing-layer {
      position: absolute;
      left: 50%;
      transform: translateX(-50%);
      object-fit: contain;
      pointer-events: none;
    }

    /* SHIRT: mannequin torso starts at ~18% of 250px = 45px from mannequin top
       In container: 170+45 = 215px top â†’ 215/420 â‰ˆ 51%
       Mannequin body width â‰ˆ 48% of 250px = 120px â†’ 48% of container */
    .shirt-ref {
      top: 51%;
      width: 50%;
      max-height: 30%;
      z-index: 25;
      filter: drop-shadow(0 3px 6px rgba(0, 0, 0, 0.25));
    }

    /* PANTS: starts at mannequin 50% = 125px from mannequin top
       In container: 170+125 = 295px â†’ 295/420 â‰ˆ 70%
       Width: ~40% of container */
    .pants-ref {
      top: 70%;
      width: 40%;
      max-height: 22%;
      z-index: 20;
      filter: drop-shadow(0 3px 6px rgba(0, 0, 0, 0.2));
    }

    /* SHOES: starts at mannequin 82% = 205px from mannequin top
       In container: 170+205 = 375px â†’ 375/420 â‰ˆ 89%
       Width: 42% */
    .shoes-ref {
      top: 89%;
      width: 42%;
      z-index: 22;
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: 2px;
      filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.2));
    }

    .shoe-left,
    .shoe-right {
      width: 48%;
      height: auto;
      object-fit: contain;
    }

    .shoe-left {
      transform: scaleX(-1);
    }

    /* pop animation */
    .reflect-anim {
      animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    }

    @keyframes popIn {
      0% {
        opacity: 0.5;
        transform: translateX(-50%) scale(1.1);
      }

      100% {
        opacity: 1;
        transform: translateX(-50%) scale(1);
      }
    }

    .shoes-pop {
      animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    }

    /* =========================================
       COMPACT OUTFIT LABEL BAR (below canvas)
       ========================================= */
    .outfit-bar {
      display: flex;
      gap: 6px;
      width: 100%;
      max-width: 260px;
      margin: 0 auto 14px;
    }

    .outfit-bar-chip {
      flex: 1;
      background: #FDF5F6;
      border: 1.5px dashed rgba(183, 110, 121, 0.3);
      border-radius: 8px;
      padding: 5px 4px;
      text-align: center;
      font-size: 0.64rem;
      font-weight: 700;
      color: #ccc;
      text-transform: uppercase;
      letter-spacing: 0.4px;
      line-height: 1.3;
      transition: all 0.2s;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .outfit-bar-chip.filled {
      border-color: var(--primary, #B76E79);
      border-style: solid;
      color: var(--primary, #B76E79);
      background: #fff5f6;
    }

    /* =========================================
       SNAP LOGIN STATUS BADGE
       ========================================= */
    .snap-status-badge {
      display: none;
      align-items: center;
      gap: 8px;
      background: linear-gradient(135deg, #FFFC00, #FFE200);
      color: #111;
      padding: 6px 14px;
      border-radius: 20px;
      font-size: 0.8rem;
      font-weight: 700;
      width: fit-content;
      margin: 0 auto 14px;
      box-shadow: 0 3px 10px rgba(255, 252, 0, 0.3);
    }

    .snap-status-badge ion-icon {
      font-size: 1rem;
    }

    /* =========================================
       AVATAR ACTIONS
       ========================================= */
    .avatar-actions {
      display: flex;
      flex-direction: column;
      gap: 14px;
      width: 100%;
      max-width: 250px;
      margin: 0 auto;
    }

    .avatar-name-field {
      width: 100%;
      padding: 13px 16px;
      border: 2px solid #FADADD;
      border-radius: 12px;
      font-size: 0.95rem;
      font-weight: 600;
      color: var(--dark, #1F0A0A);
      background: #fdfdfd;
      transition: all 0.3s ease;
      outline: none;
      font-family: inherit;
    }

    .avatar-name-field:focus {
      border-color: var(--primary, #B76E79);
      box-shadow: 0 0 0 4px rgba(183, 110, 121, 0.1);
    }

    .action-buttons {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }

    .btn-dark {
      padding: 13px 10px;
      border-radius: 12px;
      font-weight: 700;
      font-size: 0.88rem;
      cursor: pointer;
      border: none;
      background: var(--mahogany, #4D0F0F);
      color: #fff;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      font-family: inherit;
    }

    .btn-dark:hover {
      background: #3a0a0a;
      transform: translateY(-2px);
      box-shadow: 0 6px 16px rgba(77, 15, 15, 0.25);
    }

    .btn-snap {
      padding: 13px 10px;
      border-radius: 12px;
      font-weight: 700;
      font-size: 0.88rem;
      cursor: pointer;
      border: none;
      background: #FFFC00;
      color: #111;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      box-shadow: 0 4px 10px rgba(255, 252, 0, 0.3);
      font-family: inherit;
    }

    .btn-snap:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 15px rgba(255, 252, 0, 0.45);
    }

    .btn-rose {
      padding: 13px;
      border-radius: 12px;
      font-weight: 700;
      font-size: 0.88rem;
      cursor: pointer;
      border: none;
      background: linear-gradient(135deg, var(--primary, #B76E79) 0%, var(--secondary, #CD7F32) 100%);
      color: white;
      transition: all 0.3s;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      font-family: inherit;
      width: 100%;
    }

    .btn-rose:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(183, 110, 121, 0.35);
    }

    .btn-logout {
      padding: 10px 14px;
      border-radius: 10px;
      font-size: 0.85rem;
      font-weight: 600;
      cursor: pointer;
      border: 1.5px solid #FADADD;
      background: #fff;
      color: var(--mahogany, #4D0F0F);
      transition: all 0.2s;
      display: none;
      align-items: center;
      justify-content: center;
      gap: 6px;
      font-family: inherit;
    }

    .btn-logout:hover {
      background: #fff5f5;
      border-color: var(--primary, #B76E79);
    }

    /* =========================================
       WARDROBE / CLOSET
       ========================================= */
    .category-tabs {
      display: flex;
      background: #FDF5F6;
      padding: 5px;
      border-radius: 12px;
      margin-bottom: 16px;
      gap: 4px;
    }

    .tab-item {
      flex: 1;
      border: none;
      background: transparent;
      padding: 10px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 700;
      font-size: 0.88rem;
      color: #999;
      transition: all 0.2s ease;
      font-family: inherit;
    }

    .tab-item.active {
      background: white;
      color: var(--mahogany, #4D0F0F);
      box-shadow: 0 2px 8px rgba(183, 110, 121, 0.12);
    }

    .snap-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(90px, 1fr));
      gap: 12px;
      max-height: 400px;
      overflow-y: auto;
      padding: 4px 8px 8px 4px;
    }

    .snap-grid::-webkit-scrollbar {
      width: 5px;
    }

    .snap-grid::-webkit-scrollbar-thumb {
      background: #FADADD;
      border-radius: 10px;
    }

    .wardrobe-item {
      aspect-ratio: 1/1;
      background: #FDF5F6;
      border-radius: 14px;
      padding: 14px;
      border: 2px solid transparent;
      cursor: pointer;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .wardrobe-item img {
      width: 85%;
      height: 85%;
      object-fit: contain;
      transition: transform 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    }

    .wardrobe-item:hover {
      background: #fff0f2;
      border-color: rgba(183, 110, 121, 0.2);
    }

    .wardrobe-item:hover img {
      transform: scale(1.15);
    }

    .wardrobe-item.selected {
      border-color: var(--primary, #B76E79);
      background: #fff5f6;
      box-shadow: 0 4px 12px rgba(183, 110, 121, 0.2);
    }

    /* =========================================
       CUSTOMIZATION CARD
       ========================================= */
    .form-group label {
      display: block;
      margin-bottom: 7px;
      color: var(--mahogany, #4D0F0F);
      font-weight: 700;
      font-size: 0.88rem;
    }

    .custom-input {
      width: 100%;
      padding: 13px 16px;
      border: 2px solid #FADADD;
      border-radius: 12px;
      font-size: 0.92rem;
      font-weight: 600;
      color: var(--dark, #1F0A0A);
      background: #fdfdfd;
      transition: all 0.3s ease;
      outline: none;
      font-family: inherit;
    }

    .custom-input:focus {
      border-color: var(--primary, #B76E79);
      box-shadow: 0 0 0 4px rgba(183, 110, 121, 0.1);
    }

    .upload-area {
      border: 2px dashed rgba(183, 110, 121, 0.4);
      border-radius: 14px;
      padding: 28px 20px;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s ease;
      background: #fffbfa;
    }

    .upload-area:hover {
      background: #fff5f5;
      border-color: var(--primary, #B76E79);
    }

    .upload-area ion-icon {
      font-size: 2.4rem;
      color: var(--primary, #B76E79);
      margin-bottom: 8px;
    }

    .upload-area p {
      color: #999;
      font-weight: 600;
      font-size: 0.9rem;
    }

    /* =========================================
       LOOKBOOK
       ========================================= */
    .empty-msg {
      color: #bbb;
      text-align: center;
      padding: 40px 20px;
      font-style: italic;
      background: #FDF5F6;
      border-radius: 12px;
      border: 1px dashed #FADADD;
      font-size: 0.92rem;
    }

    .lookbook-display {
      flex: 1;
      display: flex;
      flex-direction: column;
      overflow-y: auto;
      max-height: 400px;
    }

    /* =========================================
       MESSAGES
       ========================================= */
    .message {
      padding: 13px 16px;
      border-radius: 10px;
      margin-bottom: 14px;
      font-weight: 600;
      font-size: 0.88rem;
      display: none;
      font-family: inherit;
    }

    .message.success {
      background: #e8f8f5;
      color: #27ae60;
      border: 1px solid #c8e6c9;
      display: block;
    }

    .message.error {
      background: #fff5f6;
      color: #e74c3c;
      border: 1px solid #FADADD;
      display: block;
    }

    /* Pop animation */
    .reflect-anim {
      animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    }

    @keyframes popIn {
      0% {
        transform: translateX(-50%) scale(1.1);
        opacity: 0.5;
      }

      100% {
        transform: translateX(-50%) scale(1);
        opacity: 1;
      }
    }

    /* Bitmoji slide-in */
    @keyframes avatarSlideIn {
      0% {
        opacity: 0;
        transform: translateX(-50%) translateY(-10px);
      }

      100% {
        opacity: 1;
        transform: translateX(-50%) translateY(0);
      }
    }

    .bitmoji-anim {
      animation: avatarSlideIn 0.4s ease forwards;
    }
  </style>
</head>

<body>
  <!-- Navigation -->
  <nav class="navbar">
    <div class="nav-container">
      <div class="nav-brand">
        <a href="index.html">
          <ion-icon name="bag-handle-outline"></ion-icon>
          <span>Dressify AI</span>
        </a>
      </div>

      <button class="nav-toggle" onclick="toggleNavMenu()">
        <ion-icon name="menu-outline"></ion-icon>
      </button>

      <ul class="nav-menu" id="navMenu">
        <li><a href="index.html" class="nav-link"><ion-icon name="home-outline"></ion-icon> Home</a></li>
        <li><a href="ai-hub.html" class="nav-link"><ion-icon name="sparkles-outline"></ion-icon> AI Hub</a></li>
        <li><a href="avatar-customizer.html" class="nav-link active"><ion-icon name="person-outline"></ion-icon>
            Avatar</a></li>
        <li><a href="gemini_chatbot.html" class="nav-link"><ion-icon name="chatbubbles-outline"></ion-icon> Chat</a>
        </li>
        <li><a href="bodyshape.html" class="nav-link"><ion-icon name="body-outline"></ion-icon> Body Shape</a></li>
        <li class="nav-divider"></li>
        <li><a href="login.html" class="nav-link auth-btn"><ion-icon name="log-in-outline"></ion-icon> Login</a></li>
        <li><a href="signup.html" class="nav-link auth-btn primary"><ion-icon name="person-add-outline"></ion-icon> Sign
            Up</a></li>
      </ul>
    </div>
  </nav>

  <!-- Page Hero -->
  <div class="avatar-hero">
    <h1>ðŸ‘— Your Style Avatar</h1>
    <p>Try on outfits on your personal mannequin â€” connect Snapchat to use your Bitmoji face</p>
  </div>

  <!-- DASHBOARD -->
  <div class="avatar-page-container">
    <div class="dashboard-grid">

      <!-- 1. TOP LEFT: Avatar Preview -->
      <div class="card">
        <h2 id="displayNameArea" class="avatar-display-name">Guest User</h2>

        <!-- Snapchat connected badge (shown when logged in) -->
        <div class="snap-status-badge" id="snapBadge">
          <ion-icon name="logo-snapchat"></ion-icon>
          Connected
        </div>

        <!-- THE MANNEQUIN CANVAS -->
        <div class="avatar-canvas" id="avatarPreviewBox">

          <!-- Mannequin image: full body, width-anchored at bottom -->
          <img id="mannequinImg" src="assets/mannequin.png" class="mannequin-img" alt="Mannequin"
            onerror="this.src='https://img.icons8.com/3d-fluency/200/man-in-tuxedo.png'">

          <!-- Bitmoji head overlay: shown only when Snap logged in -->
          <img id="userBitmoji" src="" class="bitmoji-overlay" alt="Your Bitmoji">

          <!-- Clothing overlays â€” sit ON the mannequin at calibrated body regions -->
          <div class="clothes-zone">
            <img id="reflectTop" src="" class="clothing-layer shirt-ref" style="margin: -10px; margin-left: 2px;">
            <img id="reflectBottom" src="" class="clothing-layer pants-ref" style="display:none;">
            <div id="reflectShoes" class="clothing-layer shoes-ref" style="display:none;">
              <img class="shoe-left" src="">
              <img class="shoe-right" src="">
            </div>
          </div>
        </div>

        <!-- COMPACT OUTFIT LABEL BAR -->
        <div class="outfit-bar">
          <div class="outfit-bar-chip" id="chipTop">Top</div>
          <div class="outfit-bar-chip" id="chipBottom">Bottom</div>
          <div class="outfit-bar-chip" id="chipShoe">Shoes</div>
        </div>

        <!-- Avatar actions -->
        <div class="avatar-actions">
          <input type="text" id="avatarNameInput" class="avatar-name-field" placeholder="Enter Avatar Name...">

          <div class="action-buttons">
            <button class="btn-dark" onclick="createAvatar()">Save Name</button>
            <button class="btn-snap" onclick="saveCurrentOutfit()">
              <ion-icon name="save-outline" style="font-size:1.1rem;"></ion-icon> Save Outfit
            </button>

            <!-- Login / Logout toggle -->
            <button class="btn-rose" id="snapLoginBtn" onclick="startSnapLogin()" style="grid-column: span 2;">
              <ion-icon name="logo-snapchat"></ion-icon> Connect Snapchat
            </button>
            <button class="btn-logout" id="snapLogoutBtn" onclick="logoutAndSwitch()" style="grid-column: span 2;">
              <ion-icon name="log-out-outline"></ion-icon> Switch User / Logout
            </button>
          </div>
        </div>
      </div>

      <!-- 2. TOP RIGHT: Bitmoji Closet -->
      <div class="card">
        <h2><ion-icon name="shirt-outline"></ion-icon> Bitmoji Closet</h2>
        <div class="category-tabs">
          <button class="tab-item active" onclick="changeCategory('tops', this)">Tops</button>
          <button class="tab-item" onclick="changeCategory('bottoms', this)">Bottoms</button>
          <button class="tab-item" onclick="changeCategory('shoes', this)">Shoes</button>
        </div>
        <div id="wardrobeGrid" class="snap-grid">
          <!-- Items populated by JS -->
        </div>
      </div>

      <!-- 3. BOTTOM LEFT: Customization Card -->
      <div class="card">
        <h2><ion-icon name="color-palette-outline"></ion-icon> Customization</h2>
        <div id="messageBox"></div>
        <div style="display:flex; flex-direction:column; gap:14px; margin-bottom:18px;">
          <div class="form-group">
            <label>Skin Tone</label>
            <select id="skinTone" class="custom-input">
              <option value="light">Light</option>
              <option value="medium" selected>Medium</option>
              <option value="dark">Dark</option>
            </select>
          </div>
          <div class="form-group">
            <label>Reference Image</label>
            <div class="upload-area" id="uploadArea" onclick="document.getElementById('avatarImage').click()">
              <ion-icon name="cloud-upload-outline"></ion-icon>
              <p>Click to upload reference</p>
            </div>
            <input type="file" id="avatarImage" accept="image/*" style="display:none;">
          </div>
        </div>
        <button class="btn-rose" onclick="createAvatar()">
          <ion-icon name="refresh-outline"></ion-icon> Update Profile
        </button>
      </div>

      <!-- 4. BOTTOM RIGHT: Saved Lookbook -->
      <div class="card">
        <h2><ion-icon name="bookmark-outline"></ion-icon> Saved Lookbook</h2>
        <div id="savedOutfitsContainer" class="lookbook-display">
          <p class="empty-msg">Your saved styles will appear here.</p>
        </div>
      </div>

    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  <script>
    const API_URL = "http://127.0.0.1:8000/api";
    axios.defaults.withCredentials = true;

    let currentUserId = 'guest';
    let currentAvatar = null;
    let currentTab = 'tops';
    let userSavedOutfits = [];

    let currentOutfit = { tops: null, bottoms: null, shoes: null };

    // =========================================================================
    // CLOTHING DATABASE (CSS-filtered icons)
    // =========================================================================
    const baseIcons = {
      tee: 'https://img.icons8.com/color/96/t-shirt.png',
      hoodie: 'https://img.icons8.com/color/96/hoodie.png',
      jacket: 'https://img.icons8.com/color/96/jacket.png',
      sweater: 'https://img.icons8.com/color/96/sweater.png',
      jeans: 'https://img.icons8.com/color/96/jeans.png',
      trousers: 'https://img.icons8.com/color/96/trousers.png',
      shorts: 'https://img.icons8.com/color/96/shorts.png',
      sweatpants: 'https://img.icons8.com/color/96/sweatpants.png',
      sneaker: 'https://img.icons8.com/color/96/sneakers.png',
      shoe: 'https://img.icons8.com/color/96/mens-shoe.png'
    };

    const clothingDatabase = {
      tops: [
        // w = overlay width (% of container), top = vertical start (% of container height)
        // Tees: narrow (46%), standard height
        { id: 't1', name: 'Classic Green Tee', image: baseIcons.tee, filter: 'none', w: '46%', top: '51%' },
        { id: 't2', name: 'Midnight Black Tee', image: baseIcons.tee, filter: 'grayscale(100%) brightness(30%)', w: '46%', top: '51%' },
        { id: 't9', name: 'White Graphic Tee', image: baseIcons.tee, filter: 'grayscale(100%) brightness(250%)', w: '46%', top: '51%' },
        // Hoodies: wider hood, sit a bit higher
        { id: 't3', name: 'Grey Urban Hoodie', image: baseIcons.hoodie, filter: 'grayscale(100%) brightness(130%)', w: '60%', top: '47%' },
        { id: 't4', name: 'Crimson Red Hoodie', image: baseIcons.hoodie, filter: 'hue-rotate(150deg) saturate(150%)', w: '60%', top: '47%' },
        { id: 't10', name: 'Neon Pink Hoodie', image: baseIcons.hoodie, filter: 'hue-rotate(280deg) saturate(200%) brightness(120%)', w: '60%', top: '47%' },
        // Jackets: widest, full torso
        { id: 't5', name: 'Blue Denim Jacket', image: baseIcons.jacket, filter: 'none', w: '64%', top: '46%' },
        { id: 't6', name: 'Dark Leather Jacket', image: baseIcons.jacket, filter: 'grayscale(100%) brightness(40%)', w: '64%', top: '46%' },
        // Sweaters: medium width
        { id: 't7', name: 'Mustard Knit Sweater', image: baseIcons.sweater, filter: 'hue-rotate(320deg) saturate(150%) brightness(110%)', w: '46%', top: '51%' },
        { id: 't8', name: 'Plum Violet Sweater', image: baseIcons.sweater, filter: 'hue-rotate(200deg) saturate(120%)', w: '46%', top: '51%' }
      ],
      bottoms: [
        { id: 'b1', name: 'Classic Blue Jeans', image: baseIcons.jeans, filter: 'none' },
        { id: 'b2', name: 'Faded Grey Jeans', image: baseIcons.jeans, filter: 'grayscale(100%) brightness(120%)' },
        { id: 'b3', name: 'Black Tailored Trousers', image: baseIcons.trousers, filter: 'grayscale(100%) brightness(30%)' },
        { id: 'b4', name: 'Navy Dress Pants', image: baseIcons.trousers, filter: 'hue-rotate(200deg) saturate(80%) brightness(60%)' },
        { id: 'b5', name: 'Khaki Summer Shorts', image: baseIcons.shorts, filter: 'sepia(100%) hue-rotate(350deg) saturate(150%) brightness(90%)' },
        { id: 'b6', name: 'Coral Beach Shorts', image: baseIcons.shorts, filter: 'hue-rotate(120deg) saturate(150%) brightness(110%)' },
        { id: 'b7', name: 'Heather Grey Sweats', image: baseIcons.sweatpants, filter: 'none' },
        { id: 'b8', name: 'Maroon Track Pants', image: baseIcons.sweatpants, filter: 'hue-rotate(140deg) saturate(120%) brightness(80%)' },
        { id: 'b9', name: 'Dark Wash Denim', image: baseIcons.jeans, filter: 'brightness(60%) saturate(120%)' },
        { id: 'b10', name: 'Olive Tech Cargos', image: baseIcons.trousers, filter: 'sepia(100%) hue-rotate(50deg) saturate(120%) brightness(70%)' },
        { id: 'b11', name: 'Charcoal Formal Trousers', image: baseIcons.trousers, filter: 'grayscale(100%) brightness(50%)' },
        { id: 'b12', name: 'Beige Chinos', image: baseIcons.trousers, filter: 'sepia(60%) brightness(140%) saturate(80%)' },
        { id: 'b13', name: 'Burgundy Dress Pants', image: baseIcons.trousers, filter: 'hue-rotate(150deg) saturate(100%) brightness(50%)' },
        { id: 'b14', name: 'Light Grey Suit Pants', image: baseIcons.trousers, filter: 'grayscale(100%) brightness(170%)' },
        { id: 'b15', name: 'Forest Green Chinos', image: baseIcons.trousers, filter: 'hue-rotate(80deg) saturate(80%) brightness(70%)' },
        { id: 'b16', name: 'Royal Blue Slim Trousers', image: baseIcons.trousers, filter: 'hue-rotate(210deg) saturate(120%) brightness(80%)' },
        { id: 'b17', name: 'White Linen Pants', image: baseIcons.trousers, filter: 'grayscale(100%) brightness(220%) saturate(0%)' },
        { id: 'b18', name: 'Black Jogger Pants', image: baseIcons.sweatpants, filter: 'grayscale(100%) brightness(20%)' }
      ],
      shoes: [
        { id: 's1', name: 'White High-Tops', image: baseIcons.sneaker, filter: 'grayscale(100%) brightness(200%)' },
        { id: 's2', name: 'Black Skater Shoes', image: baseIcons.sneaker, filter: 'grayscale(100%) brightness(30%)' },
        { id: 's3', name: 'Hype Red Kicks', image: baseIcons.sneaker, filter: 'hue-rotate(140deg) saturate(150%)' },
        { id: 's4', name: 'Brown Oxfords', image: baseIcons.shoe, filter: 'sepia(80%) hue-rotate(340deg) brightness(80%)' },
        { id: 's5', name: 'Black Dress Shoes', image: baseIcons.shoe, filter: 'grayscale(100%) brightness(30%)' },
        { id: 's6', name: 'Neon Green Runners', image: baseIcons.sneaker, filter: 'hue-rotate(260deg) saturate(200%)' },
        { id: 's7', name: 'Navy Slip-ons', image: baseIcons.shoe, filter: 'hue-rotate(200deg) saturate(120%) brightness(70%)' },
        { id: 's8', name: 'Vintage Yellow Kicks', image: baseIcons.sneaker, filter: 'hue-rotate(320deg) saturate(150%) brightness(110%)' },
        { id: 's9', name: 'Cherry Loafers', image: baseIcons.shoe, filter: 'hue-rotate(140deg) saturate(120%) brightness(60%)' },
        { id: 's10', name: 'Violet Trainers', image: baseIcons.sneaker, filter: 'hue-rotate(200deg) saturate(150%)' },
        { id: 's11', name: 'White Leather Oxfords', image: baseIcons.shoe, filter: 'grayscale(100%) brightness(230%)' },
        { id: 's12', name: 'Tan Desert Boots', image: baseIcons.shoe, filter: 'sepia(60%) hue-rotate(10deg) brightness(110%)' },
        { id: 's13', name: 'Navy Blue Brogues', image: baseIcons.shoe, filter: 'hue-rotate(210deg) saturate(90%) brightness(55%)' },
        { id: 's14', name: 'Grey Suede Loafers', image: baseIcons.shoe, filter: 'grayscale(60%) brightness(120%)' },
        { id: 's15', name: 'Burgundy Derby Shoes', image: baseIcons.shoe, filter: 'hue-rotate(155deg) saturate(80%) brightness(50%)' },
        { id: 's16', name: 'Olive Green Boots', image: baseIcons.shoe, filter: 'sepia(100%) hue-rotate(55deg) saturate(80%) brightness(65%)' },
        { id: 's17', name: 'Caramel Monk Straps', image: baseIcons.shoe, filter: 'sepia(100%) hue-rotate(20deg) brightness(95%)' },
        { id: 's18', name: 'Orange Chunky Sneakers', image: baseIcons.sneaker, filter: 'hue-rotate(30deg) saturate(200%) brightness(110%)' }
      ]
    };

    // =========================================================================
    // UPLOAD REFERENCE IMAGE
    // =========================================================================
    const uploadArea = document.getElementById('uploadArea');
    const avatarImageInput = document.getElementById('avatarImage');

    if (uploadArea) {
      uploadArea.addEventListener('dragover', e => { e.preventDefault(); uploadArea.style.borderColor = '#B76E79'; });
      uploadArea.addEventListener('dragleave', () => { uploadArea.style.borderColor = ''; });
      uploadArea.addEventListener('drop', e => {
        e.preventDefault();
        uploadArea.style.borderColor = '';
        if (avatarImageInput) { avatarImageInput.files = e.dataTransfer.files; previewImage(); }
      });
    }

    if (avatarImageInput) avatarImageInput.addEventListener('change', previewImage);

    function previewImage() {
      const file = avatarImageInput.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = (e) => { /* future: preview logic */ };
        reader.readAsDataURL(file);
      }
    }

    // =========================================================================
    // MESSAGE BOX
    // =========================================================================
    function showMessage(msg, type) {
      const box = document.getElementById('messageBox');
      box.textContent = msg;
      box.className = `message ${type}`;
      setTimeout(() => { box.className = 'message'; }, 3000);
    }

    // =========================================================================
    // SNAPCHAT LOGIN / LOGOUT
    // =========================================================================
    const startSnapLogin = () => {
      window.location.href = "http://127.0.0.1:8000/api/avatar/snap/login";
    };

    function logoutAndSwitch() {
      window.location.href = "http://127.0.0.1:8000/api/avatar/logout";
    }

    // =========================================================================
    // LOAD SNAP PROFILE â€” KEY LOGIC FOR MANNEQUIN STATE
    // =========================================================================
    async function loadSnapProfile() {
      try {
        const response = await fetch('http://127.0.0.1:8000/api/avatar/session', { credentials: 'include' });
        const data = await response.json();

        const bitmoji = document.getElementById('userBitmoji');
        const displayName = document.getElementById('displayNameArea');
        const nameInput = document.getElementById('avatarNameInput');
        const loginBtn = document.getElementById('snapLoginBtn');
        const logoutBtn = document.getElementById('snapLogoutBtn');
        const snapBadge = document.getElementById('snapBadge');

        if (data.user) {
          // â”€â”€ LOGGED IN STATE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          // Show bitmoji head overlaid on mannequin; hide Connect button
          currentUserId = data.user.displayName || "guest";

          if (bitmoji && data.user.bitmoji && data.user.bitmoji.avatar) {
            bitmoji.src = data.user.bitmoji.avatar;
            bitmoji.style.display = 'block';
            bitmoji.classList.add('bitmoji-anim');
          }

          displayName.textContent = data.user.displayName || "Snapchat User";
          nameInput.value = data.user.displayName || "";

          loginBtn.style.display = 'none';
          logoutBtn.style.display = 'flex';
          snapBadge.style.display = 'flex';

        } else {
          // â”€â”€ GUEST STATE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          // Show full mannequin, no bitmoji overlay
          currentUserId = 'guest';
          displayName.textContent = "Guest User";

          if (bitmoji) bitmoji.style.display = 'none';

          loginBtn.style.display = 'flex';
          logoutBtn.style.display = 'none';
          snapBadge.style.display = 'none';
        }

        loadSavedOutfits();

      } catch (err) {
        console.error("Session failed:", err);
        currentUserId = 'guest';
        document.getElementById('displayNameArea').textContent = "Guest User";
        document.getElementById('snapLoginBtn').style.display = 'flex';
        document.getElementById('snapLogoutBtn').style.display = 'none';
        document.getElementById('snapBadge').style.display = 'none';
        const bitmoji = document.getElementById('userBitmoji');
        if (bitmoji) bitmoji.style.display = 'none';
        loadSavedOutfits();
      }
    }

    window.addEventListener('DOMContentLoaded', loadSnapProfile);

    // =========================================================================
    // WARDROBE
    // =========================================================================
    function changeCategory(category, element) {
      document.querySelectorAll('.tab-item').forEach(btn => btn.classList.remove('active'));
      element.classList.add('active');
      renderClothingItems(category);
    }

    const baseDropShadow = 'drop-shadow(0 4px 8px rgba(0,0,0,0.15))';

    function renderClothingItems(category) {
      const container = document.getElementById('wardrobeGrid');
      const items = clothingDatabase[category] || [];

      if (items.length === 0) {
        container.innerHTML = `<div class="empty-msg" style="grid-column:1/-1;">Coming soon for ${category}!</div>`;
        return;
      }

      container.innerHTML = items.map(item => {
        const appliedFilter = item.filter !== 'none' ? `${item.filter} ${baseDropShadow}` : baseDropShadow;
        return `
        <div class="wardrobe-item ${currentOutfit[category] === item.id ? 'selected' : ''}"
             onclick="selectItem('${category}', '${item.id}', this)"
             data-id="${item.id}">
          <img src="${item.image}" alt="${item.name}" title="${item.name}" style="filter: ${appliedFilter};">
        </div>`;
      }).join('');
    }

    function selectItem(category, itemId, element = null) {
      if (!itemId) return;
      const itemData = clothingDatabase[category].find(i => i.id === itemId);
      if (!itemData) return;

      currentOutfit[category] = itemId;

      const appliedFilter = itemData.filter !== 'none'
        ? `${itemData.filter} drop-shadow(0 3px 6px rgba(0,0,0,0.25))`
        : 'drop-shadow(0 3px 6px rgba(0,0,0,0.2))';

      // â”€â”€ PUT CLOTHING ON THE MANNEQUIN â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      if (category === 'tops') {
        const el = document.getElementById('reflectTop');
        el.src = itemData.image;
        el.style.filter = appliedFilter;
        // Apply per-garment width and top position (falls back to CSS defaults if not set)
        el.style.width = itemData.w || '50%';
        el.style.top = itemData.top || '51%';
        el.style.display = 'block';
        el.classList.remove('reflect-anim');
        void el.offsetWidth;
        el.classList.add('reflect-anim');
      } else if (category === 'bottoms') {
        const el = document.getElementById('reflectBottom');
        el.src = itemData.image;
        el.style.filter = appliedFilter;
        el.style.display = 'block';
        el.classList.remove('reflect-anim');
        void el.offsetWidth;
        el.classList.add('reflect-anim');
      } else if (category === 'shoes') {
        const el = document.getElementById('reflectShoes');
        el.querySelector('.shoe-left').src = itemData.image;
        el.querySelector('.shoe-right').src = itemData.image;
        el.querySelector('.shoe-left').style.filter = appliedFilter;
        el.querySelector('.shoe-right').style.filter = appliedFilter;
        el.style.display = 'flex';
      }

      // â”€â”€ UPDATE COMPACT CHIP LABELS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      const chipMap = { tops: 'chipTop', bottoms: 'chipBottom', shoes: 'chipShoe' };
      const chip = document.getElementById(chipMap[category]);
      if (chip) {
        chip.textContent = itemData.name;
        chip.classList.add('filled');
      }

      // â”€â”€ HIGHLIGHT SELECTED WARDROBE CARD â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      let targetElement = element;
      if (!targetElement) {
        targetElement = document.querySelector(`.wardrobe-item[data-id="${itemId}"]`);
      }
      if (targetElement && targetElement.parentElement) {
        targetElement.parentElement.querySelectorAll('.wardrobe-item').forEach(el => el.classList.remove('selected'));
        targetElement.classList.add('selected');
      }
    }


    // =========================================================================
    // SAVE / LOAD
    // =========================================================================
    async function createAvatar() {
      const nameField = document.getElementById("avatarNameInput");
      const nameValue = nameField ? nameField.value.trim() : "";
      if (!nameValue) { alert("Please enter a name for your avatar first!"); return; }

      try {
        const response = await fetch("http://127.0.0.1:8000/api/avatar/create", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          credentials: "include",
          body: JSON.stringify({ "name": nameValue })
        });
        const data = await response.json();
        if (response.ok) {
          showMessage("Avatar Profile Saved! âœ“", "success");
        } else {
          console.error("Server Error:", data);
          showMessage("Error saving profile.", "error");
        }
      } catch (err) {
        console.error("Network Error:", err);
        showMessage("Network error. Is the server running?", "error");
      }
    }

    async function saveCurrentOutfit() {
      if (!currentOutfit.tops && !currentOutfit.bottoms && !currentOutfit.shoes) {
        showMessage('Please select some clothes first!', 'error');
        return;
      }

      const outfitName = prompt("Name your outfit:", "My Style " + Math.floor(Math.random() * 100));
      if (!outfitName) return;

      try {
        const response = await fetch(`${API_URL}/avatar/${currentUserId}/save-outfit`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ outfitName, outfit: currentOutfit })
        });
        if (response.ok) {
          showMessage('Outfit saved to lookbook! âœ“', 'success');
          loadSavedOutfits();
        } else {
          showMessage('Error saving outfit.', 'error');
        }
      } catch (error) {
        showMessage('Error saving outfit to database.', 'error');
      }
    }

    async function loadSavedOutfits() {
      try {
        const response = await fetch(`${API_URL}/avatar/${currentUserId}/outfits`);
        const data = await response.json();
        const container = document.getElementById('savedOutfitsContainer');

        if (data.outfits && data.outfits.length > 0) {
          userSavedOutfits = data.outfits;
          container.innerHTML = data.outfits.map(outfit => `
            <div style="background:#FDF5F6; border-left:4px solid #B76E79; padding:14px 16px; margin-bottom:10px; border-radius:10px; display:flex; justify-content:space-between; align-items:center;">
              <h4 style="color:#B76E79; margin:0; font-size:0.95rem; font-weight:700;">${outfit.name}</h4>
              <button onclick="loadOutfit(${outfit.id})" style="padding:8px 14px; border-radius:8px; border:none; background:var(--mahogany,#4D0F0F); color:white; font-weight:700; font-size:0.8rem; cursor:pointer; font-family:inherit;">Load Look</button>
            </div>
          `).join('');
        } else {
          container.innerHTML = `<p class="empty-msg">Your saved styles will appear here.</p>`;
        }
      } catch (error) {
        console.error('Error loading outfits:', error);
      }
    }

    function loadOutfit(outfitId) {
      const dbOutfit = userSavedOutfits.find(o => o.id === outfitId);
      if (dbOutfit && dbOutfit.outfit) {
        selectItem('tops', dbOutfit.outfit.tops, null);
        selectItem('bottoms', dbOutfit.outfit.bottoms, null);
        selectItem('shoes', dbOutfit.outfit.shoes, null);
        showMessage(`Look '${dbOutfit.name}' applied! âœ“`, 'success');
      }
    }

    // Handle URL query params (Snapchat callback fallback)
    window.addEventListener('DOMContentLoaded', () => {
      const params = new URLSearchParams(window.location.search);
      const snapBitmoji = params.get('bitmoji');
      const snapName = params.get('name');
      if (snapBitmoji) {
        const img = document.getElementById('userBitmoji');
        img.src = snapBitmoji;
        img.style.display = 'block';
        img.classList.add('bitmoji-anim');
        document.getElementById('displayNameArea').textContent = snapName || 'Snapchat User';
        document.getElementById('avatarNameInput').value = snapName || '';
        document.getElementById('snapBadge').style.display = 'flex';
        document.getElementById('snapLoginBtn').style.display = 'none';
        document.getElementById('snapLogoutBtn').style.display = 'flex';
      }
    });

    // Initialize closet
    renderClothingItems('tops');
  </script>
  <script src="js/navbar-init.js"></script>

  <footer class="footer">
    <div class="footer__container section__container">
      <div class="footer__col">
        <div class="footer__logo">
          <a href="index.html">Dressify AI</a>
        </div>
        <p>Elevating fashion through artificial intelligence. Your personal stylist in your pocket, powered by
          cutting-edge AI.</p>
        <ul class="footer__socials">
          <li><a href="#"><ion-icon name="logo-facebook"></ion-icon></a></li>
          <li><a href="#"><ion-icon name="logo-instagram"></ion-icon></a></li>
          <li><a href="#"><ion-icon name="logo-twitter"></ion-icon></a></li>
        </ul>
      </div>
      <div class="footer__col">
        <h4>Navigation</h4>
        <ul class="footer__links">
          <li><a href="index.html">Home</a></li>
          <li><a href="ai-hub.html">AI Hub</a></li>
          <li><a href="avatar-customizer.html">Avatar</a></li>
          <li><a href="gemini_chatbot.html">Chat</a></li>
          <li><a href="bodyshape.html">Body Shape</a></li>
        </ul>
      </div>
      <div class="footer__col">
        <h4>Support</h4>
        <ul class="footer__links">
          <li><a href="contact.html">Contact Us</a></li>
          <li><a href="faq.html">FAQ</a></li>
          <li><a href="privacy.html">Privacy Policy</a></li>
          <li><a href="terms.html">Terms of Service</a></li>
        </ul>
      </div>
      <div class="footer__col">
        <h4>Join Us</h4>
        <p>Subscribe to get the latest fashion trends and AI style tips delivered to your inbox.</p>
        <form style="display:flex; gap:10px; margin-top:10px;">
          <input type="email" placeholder="Your email"
            style="padding:10px 15px; border-radius:20px; border:1px solid rgba(255,255,255,0.1); background:rgba(255,255,255,0.05); color:white; flex:1;">
          <button type="submit" class="btn"
            style="padding:10px 20px; border-radius:20px; background:var(--primary); color:white; border:none; cursor:pointer; font-size:0.9rem;">Join</button>
        </form>
      </div>
    </div>
    <div class="footer__bar">
      &copy; 2026 Dressify AI. All rights reserved. Precision in Every Pixel.
    </div>
  </footer>
</body>

</html>