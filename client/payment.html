<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Payment - Dressify AI</title>
  <link href="https://cdn.jsdelivr.net/npm/remixicon@4.3.0/fonts/remixicon.css" rel="stylesheet" />
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: Segoe UI, Tahoma, Geneva, Verdana, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; display: flex; align-items: center; justify-content: center; }
    
    .container { max-width: 500px; width: 100%; }
    .card { background: white; border-radius: 10px; padding: 40px; box-shadow: 0 10px 40px rgba(0,0,0,0.2); }
    
    .header { text-align: center; margin-bottom: 30px; }
    .header i { font-size: 3rem; color: #667eea; margin-bottom: 15px; }
    .header h1 { font-size: 1.5rem; color: #222; margin-bottom: 10px; }
    .header p { color: #666; font-size: 0.95rem; }
    
    .order-info { background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 25px; }
    .info-row { display: flex; justify-content: space-between; margin-bottom: 8px; }
    .info-row label { color: #666; font-size: 0.9rem; }
    .info-row span { font-weight: 600; color: #222; }
    .info-row.total { border-top: 1px solid #ddd; padding-top: 8px; margin-top: 8px; }
    .info-row.total span { color: #667eea; font-size: 1.2rem; }
    
    .payment-section { margin-bottom: 25px; }
    .payment-section h3 { font-size: 1rem; margin-bottom: 15px; color: #222; }
    
    .payment-method { padding: 15px; border: 2px solid #ddd; border-radius: 8px; margin-bottom: 10px; cursor: pointer; transition: all 0.3s; }
    .payment-method:hover { border-color: #667eea; background: #f8f9ff; }
    .payment-method input { cursor: pointer; }
    .payment-method.active { border-color: #667eea; background: #f0f4ff; }
    
    .form-group { margin-bottom: 15px; }
    .form-group label { display: block; font-size: 0.85rem; font-weight: 600; margin-bottom: 5px; color: #555; }
    .form-group input, .form-group select { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 0.95rem; }
    .form-group input:focus, .form-group select:focus { outline: none; border-color: #667eea; }
    
    .form-row { display: grid; grid-template-columns: 2fr 1fr; gap: 15px; }
    
    .btn { width: 100%; padding: 12px; border: none; border-radius: 6px; font-size: 1rem; font-weight: 600; cursor: pointer; transition: all 0.3s; }
    .btn-primary { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; }
    .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4); }
    .btn-primary:disabled { background: #ccc; cursor: not-allowed; transform: none; }
    
    .processing { display: none; text-align: center; }
    .spinner { width: 40px; height: 40px; border: 4px solid #f3f3f3; border-top: 4px solid #667eea; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 15px; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    
    .message { padding: 15px; border-radius: 8px; margin-bottom: 20px; display: none; }
    .message.success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
    .message.error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
    
    .security { text-align: center; color: #999; font-size: 0.85rem; margin-top: 20px; }
    .security i { color: #667eea; }
  </style>
</head>
<body>
  <div class="container">
    <div class="card">
      <div class="header">
        <i class="ri-secure-payment-line"></i>
        <h1>Secure Payment</h1>
        <p>Complete your order with Dressify AI</p>
      </div>

      <div id="successMsg" class="message success"></div>
      <div id="errorMsg" class="message error"></div>

      <div class="order-info" id="orderInfo">
        <div class="info-row">
          <label>Order ID:</label>
          <span id="orderId">-</span>
        </div>
        <div class="info-row">
          <label>Items:</label>
          <span id="itemCount">0</span>
        </div>
        <div class="info-row">
          <label>Subtotal:</label>
          <span id="subtotal">â‚¹0</span>
        </div>
        <div class="info-row total">
          <label>Amount to Pay:</label>
          <span id="totalAmount">â‚¹0</span>
        </div>
      </div>

      <div class="payment-section">
        <h3>Select Payment Method</h3>
        <label class="payment-method active" onclick="selectMethod(this, 'card')">
          <input type="radio" name="paymentMethod" value="card" checked />
          <span>ðŸ’³ Credit/Debit Card</span>
        </label>
        <label class="payment-method" onclick="selectMethod(this, 'upi')">
          <input type="radio" name="paymentMethod" value="upi" />
          <span>ðŸ“± UPI Payment</span>
        </label>
        <label class="payment-method" onclick="selectMethod(this, 'wallet')">
          <input type="radio" name="paymentMethod" value="wallet" />
          <span>ðŸ’° Digital Wallet</span>
        </label>
        <label class="payment-method" onclick="selectMethod(this, 'cod')">
          <input type="radio" name="paymentMethod" value="cod" />
          <span>ðŸšš Cash on Delivery</span>
        </label>
      </div>

      <div id="cardForm">
        <div class="form-group">
          <label>Cardholder Name *</label>
          <input type="text" id="cardName" placeholder="John Doe" />
        </div>
        
        <div class="form-group">
          <label>Card Number *</label>
          <input type="text" id="cardNumber" placeholder="1234 5678 9012 3456" maxlength="19" />
        </div>

        <div class="form-row">
          <div class="form-group">
            <label>Expiry (MM/YY) *</label>
            <input type="text" id="cardExpiry" placeholder="12/25" maxlength="5" />
          </div>
          <div class="form-group">
            <label>CVV *</label>
            <input type="text" id="cardCVV" placeholder="123" maxlength="4" />
          </div>
        </div>
      </div>

      <div id="upiForm" style="display: none;">
        <div class="form-group">
          <label>UPI ID *</label>
          <input type="text" id="upiId" placeholder="yourname@upi" />
        </div>
      </div>

      <div id="walletForm" style="display: none;">
        <div class="form-group">
          <label>Select Wallet *</label>
          <select id="walletType">
            <option value="">Choose a wallet</option>
            <option value="paytm">Paytm</option>
            <option value="googlepay">Google Pay</option>
            <option value="phonepe">PhonePe</option>
            <option value="amazonpay">Amazon Pay</option>
          </select>
        </div>
        <div class="form-group">
          <label>Phone Number *</label>
          <input type="tel" id="walletPhone" placeholder="9999999999" />
        </div>
      </div>

      <div id="codForm" style="display: none;">
        <p style="color: #666; text-align: center; padding: 20px; background: #f8f9fa; border-radius: 8px;">
          <i class="ri-check-line" style="color: #28a745; font-size: 2rem;"></i><br>
          You can pay when your order arrives at your doorstep.
        </p>
      </div>

      <div id="processing" class="processing">
        <div class="spinner"></div>
        <p>Processing your payment...</p>
      </div>

      <button class="btn btn-primary" id="payBtn" onclick="processPayment()">Pay â‚¹<span id="payAmount">0</span></button>

      <div class="security">
        <p><i class="ri-shield-check-line"></i> Your payment is secure and encrypted</p>
      </div>
    </div>
  </div>

  <script src="js/auth-utils.js"></script>
  <script>
    const API_BASE_URL = 'http://127.0.0.1:8000/api';

    // Get order ID from URL
    const params = new URLSearchParams(window.location.search);
    const orderId = params.get('orderId');

    function selectMethod(el, method) {
      // Remove active class from all
      document.querySelectorAll('.payment-method').forEach(m => m.classList.remove('active'));
      el.classList.add('active');

      // Hide all forms
      document.getElementById('cardForm').style.display = 'none';
      document.getElementById('upiForm').style.display = 'none';
      document.getElementById('walletForm').style.display = 'none';
      document.getElementById('codForm').style.display = 'none';

      // Show selected form
      if (method === 'card') {
        document.getElementById('cardForm').style.display = 'block';
      } else if (method === 'upi') {
        document.getElementById('upiForm').style.display = 'block';
      } else if (method === 'wallet') {
        document.getElementById('walletForm').style.display = 'block';
      } else if (method === 'cod') {
        document.getElementById('codForm').style.display = 'block';
      }
    }

    async function loadOrder() {
      if (!orderId) {
        showError('Order ID not found');
        return;
      }

      try {
        const res = await fetch(`${API_BASE_URL}/orders/${orderId}`, {
          headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
        });

        if (res.ok) {
          const data = await res.json();
          const order = data.order;
          
          document.getElementById('orderId').textContent = order._id;
          document.getElementById('itemCount').textContent = order.items.length;
          
          let subtotal = 0;
          order.items.forEach(item => {
            subtotal += item.price * item.quantity;
          });
          
          document.getElementById('subtotal').textContent = `â‚¹${subtotal}`;
          document.getElementById('totalAmount').textContent = `â‚¹${order.total}`;
          document.getElementById('payAmount').textContent = order.total;
        }
      } catch (err) {
        showError('Failed to load order');
      }
    }

    async function processPayment() {
      const method = document.querySelector('input[name="paymentMethod"]:checked').value;
      const btn = document.getElementById('payBtn');
      const processing = document.getElementById('processing');

      btn.disabled = true;
      processing.style.display = 'block';

      try {
        let paymentData = { method };

        if (method === 'card') {
          paymentData = {
            method,
            cardName: document.getElementById('cardName').value,
            cardNumber: document.getElementById('cardNumber').value.replace(/\s/g, ''),
            cardExpiry: document.getElementById('cardExpiry').value,
            cardCVV: document.getElementById('cardCVV').value
          };

          if (!paymentData.cardName || !paymentData.cardNumber || !paymentData.cardExpiry || !paymentData.cardCVV) {
            showError('Please fill all card details');
            btn.disabled = false;
            processing.style.display = 'none';
            return;
          }
        } else if (method === 'upi') {
          paymentData = {
            method,
            upiId: document.getElementById('upiId').value
          };
          if (!paymentData.upiId) {
            showError('Please enter UPI ID');
            btn.disabled = false;
            processing.style.display = 'none';
            return;
          }
        } else if (method === 'wallet') {
          paymentData = {
            method,
            walletType: document.getElementById('walletType').value,
            walletPhone: document.getElementById('walletPhone').value
          };
          if (!paymentData.walletType || !paymentData.walletPhone) {
            showError('Please select wallet and enter phone');
            btn.disabled = false;
            processing.style.display = 'none';
            return;
          }
        }

        // Call payment API
        const res = await fetch(`${API_BASE_URL}/orders/${orderId}/pay`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${localStorage.getItem('token')}`
          },
          body: JSON.stringify(paymentData)
        });

        const data = await res.json();

        if (res.ok) {
          showSuccess('Payment successful! Your order has been confirmed.');
          setTimeout(() => {
            window.location.href = 'index.html';
          }, 2000);
        } else {
          showError(data.message || 'Payment failed');
          btn.disabled = false;
          processing.style.display = 'none';
        }
      } catch (err) {
        showError(err.message);
        btn.disabled = false;
        processing.style.display = 'none';
      }
    }

    function showError(msg) {
      const el = document.getElementById('errorMsg');
      el.textContent = msg;
      el.style.display = 'block';
    }

    function showSuccess(msg) {
      const el = document.getElementById('successMsg');
      el.textContent = msg;
      el.style.display = 'block';
    }

    // Load order on page load
    loadOrder();
  </script>
</body>
</html>
